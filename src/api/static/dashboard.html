<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telematics Insurance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .login-card, .dashboard-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .login-card {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }

        .logo {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input[type="email"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-msg {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .email-display {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 5px solid #667eea;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .premium-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .premium-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .premium-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            margin: 20px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .calculation-steps {
            display: none;
            margin-top: 20px;
        }

        .calculation-steps.active {
            display: block;
        }

        .step {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .step.completed {
            background: #e8f5e8;
            border-left-color: #4CAF50;
        }

        .premium-result {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 15px;
            margin-top: 20px;
        }

        .premium-result.active {
            display: block;
        }

        .old-premium {
            font-size: 1.2em;
            color: #666;
            text-decoration: line-through;
            margin-bottom: 10px;
        }

        .new-premium {
            font-size: 3em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .savings {
            font-size: 1.5em;
            color: #4CAF50;
            font-weight: 600;
        }

        .risk-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
        }

        .risk-low { background: #4CAF50; }
        .risk-medium { background: #FF9800; }
        .risk-high { background: #F44336; }
        .risk-very-high { background: #9C27B0; }

        .insights-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .insights-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .recommendation {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .error-msg {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .error-msg.active {
            display: block;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .login-card, .dashboard-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-card">
            <div class="logo"> Telematics Driven Insurance</div>
            <h2>Sign in to your account</h2>
            <p style="color: #666; margin-bottom: 30px;">Enter your email to view your driving dashboard</p>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="Enter your email address" required>
            </div>
            
            <button class="btn" onclick="login()">Sign In</button>
            
            <div id="loginError" class="error-msg">
                Driver not found with this email address
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard">
            <div class="header">
                <h1 class="welcome-msg">Welcome back, <span id="driverName"></span>!</h1>
                <p class="email-display" id="driverEmail"></p>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card" id="topRiskCard" style="display: none;">
                    <div class="stat-value" id="riskScore">--</div>
                    <div class="stat-label">Risk Score</div>
                    <div id="riskBadge" class="risk-badge risk-medium" style="margin-top: 10px;">Calculate Premium to See Risk Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTrips">--</div>
                    <div class="stat-label">Total Trips</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDistance">--</div>
                    <div class="stat-label">Distance (km)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="averageScore">--</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            </div>

            <!-- Premium Calculation Section -->
            <div class="premium-section">
                <div class="premium-header">
                    <h2 class="premium-title">Insurance Premium Calculator</h2>
                    <p>Calculate your personalized premium based on your driving behavior</p>
                </div>

                <button class="btn calculate-btn" onclick="calculatePremium()">
                    Calculate My Premium
                </button>

                <!-- Loading Animation -->
                <div id="loadingSection" class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing your driving data...</p>
                </div>

                <!-- Calculation Steps -->
                <div id="calculationSteps" class="calculation-steps">
                    <div id="step1" class="step">
                        <strong>Step 1:</strong> Collecting your trip data...
                    </div>
                    <div id="step2" class="step">
                        <strong>Step 2:</strong> Calculating risk score using ML models...
                    </div>
                    <div id="step3" class="step">
                        <strong>Step 3:</strong> Determining premium adjustments...
                    </div>
                    <div id="step4" class="step">
                        <strong>Step 4:</strong> Finalizing your personalized premium...
                    </div>
                </div>

                <!-- Premium Result -->
                <div id="premiumResult" class="premium-result">
                    <div class="old-premium">Previous Premium: $<span id="oldPremium">1000.00</span></div>
                    <div class="new-premium">$<span id="newPremium">850.00</span></div>
                    <div class="savings">You saved $<span id="savings">150.00</span>!</div>
                    
                    <!-- Risk Score Display -->
                    <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: #333;">Your Risk Assessment</h3>
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                            <div style="font-size: 2.5em; font-weight: bold; color: #667eea; margin-right: 15px;" id="calculatedRiskScore">--</div>
                            <div>
                                <div style="font-size: 1.2em; color: #333;">Risk Score</div>
                                <div id="calculatedRiskBadge" class="risk-badge risk-medium">Medium Risk</div>
                            </div>
                        </div>
                        <div id="riskInsights" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <p style="margin: 0; color: #555; line-height: 1.6;">Risk assessment will appear after calculation...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Driving Insights - Hidden until after calculation -->
            <div id="insightsSection" class="insights-section" style="display: none;">
                <h2 class="insights-title">Additional Driving Insights</h2>
                <div id="recommendations">
                    <div class="recommendation">
                        Additional insights will appear after premium calculation...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDriverId = null;
        let dashboardData = null;

        async function login() {
            const email = document.getElementById('email').value;
            const errorMsg = document.getElementById('loginError');
            
            if (!email) {
                errorMsg.textContent = 'Please enter your email address';
                errorMsg.classList.add('active');
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `email=${encodeURIComponent(email)}`
                });

                if (response.ok) {
                    const data = await response.json();
                    currentDriverId = data.driver_id;
                    
                    document.getElementById('driverName').textContent = data.name;
                    document.getElementById('driverEmail').textContent = data.email;
                    
                    // Hide login, show dashboard
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dashboardSection').classList.add('active');
                    
                    // Load dashboard data
                    await loadDashboardData();
                    
                    errorMsg.classList.remove('active');
                } else {
                    const error = await response.json();
                    errorMsg.textContent = error.detail;
                    errorMsg.classList.add('active');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMsg.textContent = 'Connection error. Please try again.';
                errorMsg.classList.add('active');
            }
        }

        async function loadDashboardData() {
            try {
                // Load dashboard summary
                const dashboardResponse = await fetch(`/dashboard/${currentDriverId}`);
                if (dashboardResponse.ok) {
                    dashboardData = await dashboardResponse.json();
                    updateDashboardUI(dashboardData);
                }

                // Load driving insights
                const insightsResponse = await fetch(`/driving-insights/${currentDriverId}`);
                if (insightsResponse.ok) {
                    const insights = await insightsResponse.json();
                    updateInsights(insights);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateDashboardUI(data) {
            document.getElementById('riskScore').textContent = data.current_risk_score?.toFixed(1) || '--';
            document.getElementById('totalTrips').textContent = data.total_trips || '--';
            document.getElementById('totalDistance').textContent = data.total_distance?.toFixed(1) || '--';
            document.getElementById('averageScore').textContent = data.average_score?.toFixed(1) || '--';

            // Update risk badge
            const riskBadge = document.getElementById('riskBadge');
            const riskCategory = data.risk_category || 'medium';
            riskBadge.className = `risk-badge risk-${riskCategory.toLowerCase()}`;
            riskBadge.textContent = `${riskCategory.charAt(0).toUpperCase() + riskCategory.slice(1)} Risk`;
        }

        function updateInsights(insights) {
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '';

            if (insights.recommendations && insights.recommendations.length > 0) {
                insights.recommendations.forEach(rec => {
                    const div = document.createElement('div');
                    div.className = 'recommendation';
                    div.innerHTML = `<strong>Tip:</strong> ${rec}`;
                    recommendationsDiv.appendChild(div);
                });
            }
        }

        async function calculatePremium() {
            const loadingSection = document.getElementById('loadingSection');
            const calculationSteps = document.getElementById('calculationSteps');
            const premiumResult = document.getElementById('premiumResult');
            const calculateBtn = document.querySelector('.calculate-btn');

            // Reset UI
            loadingSection.classList.add('active');
            calculationSteps.classList.add('active');
            premiumResult.classList.remove('active');
            calculateBtn.disabled = true;

            // Reset steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('completed');
            });

            try {
                // Step 1: Show data collection
                await delay(1000);
                document.getElementById('step1').classList.add('completed');

                // Step 2: Calculate risk score
                await delay(1500);
                document.getElementById('step2').classList.add('completed');

                // Step 3: Determine adjustments
                await delay(1200);
                document.getElementById('step3').classList.add('completed');

                // Step 4: Finalize premium
                await delay(1000);
                document.getElementById('step4').classList.add('completed');

                // Get dashboard data which includes the actual calculated premium
                const dashboardResponse = await fetch(`/dashboard/${currentDriverId}`);
                if (dashboardResponse.ok) {
                    const dashboardData = await dashboardResponse.json();
                    
                    // Use the actual calculated premiums from the database
                    const basePremium = dashboardData.current_premium - dashboardData.premium_change;
                    const newPremium = dashboardData.current_premium;
                    const change = dashboardData.premium_change;

                    // Update premium display with real data
                    document.getElementById('oldPremium').textContent = basePremium.toFixed(2);
                    document.getElementById('newPremium').textContent = newPremium.toFixed(2);
                    document.getElementById('savings').textContent = Math.abs(change).toFixed(2);

                    // Update savings text based on actual premium change
                    const savingsElement = document.querySelector('.savings');
                    if (change < 0) {
                        savingsElement.textContent = `You saved $${Math.abs(change).toFixed(2)}!`;
                        savingsElement.style.color = '#4CAF50';
                    } else {
                        savingsElement.textContent = `Premium increased by $${change.toFixed(2)}`;
                        savingsElement.style.color = '#F44336';
                    }
                    
                    // Display risk score and insights
                    displayRiskAssessment(dashboardData.current_risk_score, dashboardData.risk_category);
                    
                } else {
                    // Fallback if dashboard data not available
                    console.error('Could not load dashboard data for premium calculation');
                    document.getElementById('oldPremium').textContent = '1200.00';
                    document.getElementById('newPremium').textContent = '1200.00';
                    document.getElementById('savings').textContent = '0.00';
                    document.querySelector('.savings').textContent = 'Premium calculation unavailable';
                }

                // Show result
                loadingSection.classList.remove('active');
                premiumResult.classList.add('active');

            } catch (error) {
                console.error('Error calculating premium:', error);
                loadingSection.classList.remove('active');
            } finally {
                calculateBtn.disabled = false;
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function displayRiskAssessment(riskScore, riskCategory) {
            // Show and update top risk score card
            document.getElementById('topRiskCard').style.display = 'block';
            document.getElementById('riskScore').textContent = riskScore.toFixed(1);
            
            // Update calculated risk score display
            document.getElementById('calculatedRiskScore').textContent = riskScore.toFixed(1);
            
            // Update both risk badges
            const topRiskBadge = document.getElementById('riskBadge');
            const calculatedRiskBadge = document.getElementById('calculatedRiskBadge');
            
            const badgeClass = `risk-badge risk-${riskCategory.toLowerCase().replace('_', '-')}`;
            topRiskBadge.className = badgeClass;
            calculatedRiskBadge.className = badgeClass;
            
            // Set badge text and insights based on risk category
            let badgeText, insights;
            
            switch(riskCategory.toLowerCase()) {
                case 'low':
                    badgeText = 'Low Risk';
                    insights = `🌟 <strong>Excellent work!</strong> Your driving demonstrates exceptional safety habits. Scores in this range (${riskScore.toFixed(1)}/100) typically excel in areas like smooth acceleration, gentle braking, and consistent speed management. You're among our safest drivers and qualify for our best premium rates. Keep up the outstanding driving!`;
                    break;
                    
                case 'medium':
                    badgeText = 'Medium Risk';
                    insights = `👍 <strong>Good driving overall!</strong> Your score of ${riskScore.toFixed(1)}/100 reflects solid driving habits with room for minor improvements. Drivers in this range typically show consistent performance with occasional harsh events. Focus on smoother acceleration and maintaining steady speeds to potentially lower your premium further.`;
                    break;
                    
                case 'high':
                    badgeText = 'High Risk';
                    insights = `⚠️ <strong>Areas for improvement identified.</strong> Your score of ${riskScore.toFixed(1)}/100 suggests frequent harsh driving events. Drivers in this range often experience hard braking, rapid acceleration, or speeding incidents. By focusing on gentler driving techniques and maintaining safe following distances, you could significantly improve your score and reduce your premium.`;
                    break;
                    
                case 'very_high':
                default:
                    badgeText = 'Very High Risk';
                    insights = `🚨 <strong>Immediate attention recommended.</strong> Your score of ${riskScore.toFixed(1)}/100 indicates concerning driving patterns with frequent safety events. This typically includes multiple hard braking incidents, aggressive acceleration, and speed violations. We strongly recommend reviewing your driving habits - small changes in technique can lead to substantial improvements in both safety and premium costs.`;
                    break;
            }
            
            topRiskBadge.textContent = badgeText;
            calculatedRiskBadge.textContent = badgeText;
            document.getElementById('riskInsights').innerHTML = `<p style="margin: 0; color: #555; line-height: 1.6;">${insights}</p>`;
            
            // Show the additional insights section
            document.getElementById('insightsSection').style.display = 'block';
            
            // Add some additional tips based on risk level
            const recommendationsDiv = document.getElementById('recommendations');
            let additionalTips = '';
            
            switch(riskCategory.toLowerCase()) {
                case 'low':
                    additionalTips = `
                        <div class="recommendation">
                            <strong>🏆 Premium Discount Qualified:</strong> Your excellent driving has earned you significant savings on your insurance premium.
                        </div>
                        <div class="recommendation">
                            <strong>📊 Maintain Your Record:</strong> Continue your safe driving practices to keep enjoying these low rates.
                        </div>`;
                    break;
                case 'medium':
                    additionalTips = `
                        <div class="recommendation">
                            <strong>🎯 Improvement Opportunity:</strong> Small adjustments to your driving style could unlock additional savings.
                        </div>
                        <div class="recommendation">
                            <strong>🚗 Driving Tip:</strong> Try increasing your following distance to reduce the need for sudden braking.
                        </div>`;
                    break;
                case 'high':
                    additionalTips = `
                        <div class="recommendation">
                            <strong>🚦 Focus Area:</strong> Reducing harsh events could significantly lower your premium next term.
                        </div>
                        <div class="recommendation">
                            <strong>🔄 Quick Win:</strong> Practice gradual acceleration and braking for immediate score improvements.
                        </div>`;
                    break;
                default:
                    additionalTips = `
                        <div class="recommendation">
                            <strong>🎯 Priority Action:</strong> Consider defensive driving courses to improve your techniques and reduce premiums.
                        </div>
                        <div class="recommendation">
                            <strong>📞 Support Available:</strong> Contact us for personalized driving improvement resources.
                        </div>`;
                    break;
            }
            
            recommendationsDiv.innerHTML = additionalTips;
        }

        // Allow Enter key to login
        document.getElementById('email').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
